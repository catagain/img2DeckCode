<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>遊戲王卡片辨識系統</title>
    <style>
        :root {
            --primary: #0071e3;
            --success: #34c759;
            --danger: #ff3b30;
            --bg: #f5f5f7;
            --card: #ffffff;
            --text: #1d1d1f;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: var(--card);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        }

        header { text-align: center; margin-bottom: 30px; }
        h1 { margin: 0; font-size: 24px; letter-spacing: -0.5px; }
        .desc { color: #86868b; font-size: 14px; margin-top: 5px; }

        /* 上傳區 */
        .upload-section {
            border: 2px dashed #d2d2d7;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 20px;
        }
        .upload-section:hover { border-color: var(--primary); background: #fbfbff; }
        #previewImg { max-width: 100%; max-height: 300px; border-radius: 8px; display: none; margin: 15px auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

        /* 按鈕 */
        button {
            width: 100%;
            padding: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:disabled { background: #d2d2d7; cursor: not-allowed; }

        /* 進度條 */
        .progress-box { display: none; margin: 25px 0; }
        .progress-container { width: 100%; height: 8px; background: #e5e5e5; border-radius: 4px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: var(--primary); transition: width 0.3s ease; }
        .progress-text { display: flex; justify-content: space-between; margin-top: 8px; font-size: 13px; color: #6e6e73; }

        /* 結果顯示區 */
        .results-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 30px; }
        .result-item { display: none; }
        h3 { font-size: 16px; margin-bottom: 10px; border-left: 4px solid var(--primary); padding-left: 10px; }
        
        #fullGridImg { width: 100%; border-radius: 10px; border: 1px solid #d2d2d7; }
        pre { background: #1d1d1f; color: #f5f5f7; padding: 20px; border-radius: 10px; font-size: 13px; overflow-x: auto; max-height: 400px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Deck Recognizer</h1>
        <p class="desc">上傳遊戲截圖，即時獲取卡表 JSON 與辨識結果圖</p>
    </header>

    <div class="upload-section" onclick="document.getElementById('fileInput').click()">
        <input type="file" id="fileInput" accept="image/*" style="display: none;">
        <div id="uploadText">點擊此處選擇 Deck 圖片</div>
        <img id="previewImg" alt="Preview">
    </div>

    <button id="processBtn" disabled>開始辨識 (Start Recognition)</button>

    <div class="progress-box" id="progressBox">
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="progress-text">
            <span id="statusLabel">正在準備辨識...</span>
            <span id="countLabel">0 / 0</span>
        </div>
    </div>

    <div class="results-grid">
        <div class="result-item" id="imageResultItem">
            <h3>辨識成果圖 (Output Grid)</h3>
            <img id="fullGridImg" src="" alt="Full Grid Result">
        </div>

        <div class="result-item" id="jsonResultItem">
            <h3>卡表數據 (JSON Data)</h3>
            <pre id="jsonOutput">{ "awaiting": "upload" }</pre>
        </div>
    </div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const processBtn = document.getElementById('processBtn');
    const previewImg = document.getElementById('previewImg');
    const uploadText = document.getElementById('uploadText');
    const progressBox = document.getElementById('progressBox');
    const progressBar = document.getElementById('progressBar');
    const statusLabel = document.getElementById('statusLabel');
    const countLabel = document.getElementById('countLabel');
    const jsonOutput = document.getElementById('jsonOutput');
    const fullGridImg = document.getElementById('fullGridImg');
    
    // Result containers
    const imageResultItem = document.getElementById('imageResultItem');
    const jsonResultItem = document.getElementById('jsonResultItem');

    let selectedFile = null;

    // 處理圖片選擇預覽
    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (event) => {
                previewImg.src = event.target.result;
                previewImg.style.display = 'block';
                uploadText.style.display = 'none';
                processBtn.disabled = false;
                
                // 重置之前的結果
                imageResultItem.style.display = 'none';
                jsonResultItem.style.display = 'none';
                progressBox.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    };

    // WebSocket 執行辨識
    processBtn.onclick = () => {
        if (!selectedFile) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            // 建立 WebSocket 連線 (位址需對應 FastAPI)
            const socket = new WebSocket('ws://' + window.location.host + '/ws/recognize');
            socket.binaryType = 'arraybuffer';

            // UI 狀態更新
            processBtn.disabled = true;
            progressBox.style.display = 'block';
            progressBar.style.width = '0%';
            statusLabel.innerText = "正在連線伺服器...";
            jsonOutput.innerText = "等待伺服器處理...";

            socket.onopen = () => {
                statusLabel.innerText = "已連線，正在傳送圖片...";
                socket.send(e.target.result);
            };

            socket.onmessage = (event) => {
                const msg = JSON.parse(event.data);

                if (msg.type === "progress") {
                    // 更新進度條
                    progressBar.style.width = msg.percent + '%';
                    countLabel.innerText = `${msg.current} / ${msg.total}`;
                    statusLabel.innerText = `正在辨識卡片：${msg.current} / ${msg.total}`;
                } 
                else if (msg.type === "final") {
                    // 顯示最終結果
                    statusLabel.innerText = "辨識完成！";
                    progressBar.style.width = '100%';
                    
                    // 顯示 JSON
                    jsonOutput.innerText = JSON.stringify(msg.data, null, 4);
                    jsonResultItem.style.display = 'block';

                    // 顯示 Grid 圖片 (利用 FastAPI 的靜態資源映射)
                    if (msg.image_url) {
                        fullGridImg.src = msg.image_url + "?t=" + new Date().getTime(); // 加 timestamp 防止快取
                        imageResultItem.style.display = 'block';
                    }

                    processBtn.disabled = false;
                    socket.close();
                } 
                else if (msg.type === "error") {
                    statusLabel.innerText = "錯誤：" + msg.message;
                    statusLabel.style.color = "var(--danger)";
                    processBtn.disabled = false;
                }
            };

            socket.onerror = (err) => {
                statusLabel.innerText = "連線失敗，請檢查後端是否啟動";
                processBtn.disabled = false;
            };
        };
        reader.readAsArrayBuffer(selectedFile);
    };
</script>

</body>
</html>